import streamlit as st
import tensorflow as tf
import io
from PIL import Image
import numpy as np
import pandas as pd
import plotly.express as px


# --- ğŸ”¹ FunÃ§Ã£o para carregar e prÃ©-processar a imagem ---
def carrega_imagem():
    uploaded_file = st.file_uploader(
        'ğŸ©º Envie uma radiografia de tÃ³rax (formato PNG, JPG ou JPEG):',
        type=['png', 'jpg', 'jpeg']
    )

    if uploaded_file is not None:
        image_data = uploaded_file.read()
        image = Image.open(io.BytesIO(image_data))

        # Converte para RGB (3 canais)
        image = image.convert("RGB")

        st.image(image, caption='Imagem carregada com sucesso!', use_container_width=True)

        # Redimensiona para o tamanho esperado pelo modelo
        image = image.resize((256, 256))

        # Converte para array NumPy e normaliza
        image = np.array(image, dtype=np.float32)
        image = image / 255.0

        # Adiciona dimensÃ£o do batch: [1, 256, 256, 3]
        image = np.expand_dims(image, axis=0)

        st.write("ğŸ§¾ Formato final da imagem:", image.shape)  # debug
        return image

    return None


# --- ğŸ”¹ FunÃ§Ã£o para previsÃ£o ---
def previsao(image):
    # Recria o interpretador do zero para cada previsÃ£o (evita previsÃµes repetidas)
    interpreter = tf.lite.Interpreter(model_path='cnn_models/modelo_quantizado16bits.tflite')
    interpreter.allocate_tensors()

    input_details = interpreter.get_input_details()
    output_details = interpreter.get_output_details()

    # Envia imagem ao modelo
    interpreter.set_tensor(input_details[0]['index'], image)
    interpreter.invoke()

    # ObtÃ©m a saÃ­da (probabilidade da classe "Pneumonia")
    output_data = interpreter.get_tensor(output_details[0]['index'])[0][0]  # Ãºnico valor sigmoid

    # Calcula probabilidades
    prob_pneumonia = float(output_data)
    prob_normal = 1 - prob_pneumonia

    # Organiza os dados para o grÃ¡fico
    classes = ['Normal', 'Pneumonia']
    probabilidades = [prob_normal, prob_pneumonia]

    df = pd.DataFrame({
        'Classe': classes,
        'Probabilidade (%)': 100 * np.array(probabilidades)
    })

    # GrÃ¡fico horizontal
    fig = px.bar(
        df,
        y='Classe',
        x='Probabilidade (%)',
        orientation='h',
        text='Probabilidade (%)',
        color='Classe',
        title='Resultado da ClassificaÃ§Ã£o'
    )
    st.plotly_chart(fig, use_container_width=True)

    # Resultado final
    classe_predita = classes[np.argmax(probabilidades)]
    probabilidade = np.max(probabilidades) * 100
    st.success(f'ğŸ“Š Resultado: **{classe_predita}** com {probabilidade:.2f}% de confianÃ§a.')

    # Mostra valor bruto para depuraÃ§Ã£o
    st.caption(f"ğŸ” Valor bruto da saÃ­da sigmoid: {output_data:.6f}")


# --- ğŸ”¹ FunÃ§Ã£o principal ---
def main():
    st.set_page_config(page_title="ClassificaÃ§Ã£o de Pneumonia", page_icon="ğŸ«", layout="centered")
    st.title('ğŸ« ClassificaÃ§Ã£o de Radiografias de TÃ³rax')
    st.write('Este aplicativo usa um modelo de **Deep Learning (CNN)** para identificar se a radiografia Ã© **Normal** ou apresenta **Pneumonia**.')

    image = carrega_imagem()

    if image is not None:
        previsao(image)


# --- ğŸš€ ExecuÃ§Ã£o ---
if __name__ == "__main__":
    main()
